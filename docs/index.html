<!DOCTYPE html>
<html lang="es">
<head>
<!-- Agrega estos headers para evitar problemas de CORS -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
  style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
  img-src 'self' data: https://*.tile.openstreetmap.org;
  connect-src 'self' https://parseapi.back4app.com https://yoli-test.work.gd;
  font-src 'self' https://fonts.gstatic.com;
  frame-src 'self' https://www.youtube.com;
  worker-src 'self' https://www.youtube.com;
  object-src 'none';
  media-src 'self';
">

<!-- Agrega esto para permitir acceso al modelo -->
<meta http-equiv="Access-Control-Allow-Origin" content="*">
<meta http-equiv="Access-Control-Allow-Methods" content="GET, OPTIONS">
<meta http-equiv="Access-Control-Allow-Headers" content="Content-Type">
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GeoRiesgo Caracas - Sistema de Alerta Temprana</title>
  
  <!-- Hojas de estilo -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
        integrity="sha256-p4NxA76iV4Li19fHCp9I8l9Jj3V5k8Xm8cYHm6Q6qQ3j8=" 
        crossorigin=""/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #003865;
      --secondary: #D52B1E;
      --accent: #F9D71C;
      --light: #F8F9FA;
      --dark: #212529;
      --card: #FFFFFF;
      --border: #DEE2E6;
      --critical: #d62728;
      --high: #ff7f0e;
      --moderate: #ffcc00;
      --low: #2ca02c;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--light);
      color: #333;
      line-height: 1.6;
    }
    
    .container {
      display: flex;
      min-height: 100vh;
    }
    
    /* Sidebar */
    .sidebar {
      width: 320px;
      background-color: var(--card);
      border-right: 1px solid var(--border);
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    
    .sidebar-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .sidebar-header h1 {
      color: var(--primary);
      font-size: 1.8rem;
      margin-bottom: 5px;
    }
    
    .sidebar-header p {
      color: #666;
      font-size: 0.9rem;
    }
    
    .section {
      margin-bottom: 25px;
      background: var(--card);
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    
    .section h2 {
      font-size: 1.3rem;
      color: var(--primary);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .section h2 i {
      color: var(--secondary);
    }
    
    .radio-option {
      margin-bottom: 12px;
      padding: 12px;
      border-radius: 6px;
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .radio-option:hover {
      background-color: #f0f8ff;
    }
    
    .radio-option input[type="radio"] {
      margin-right: 10px;
      width: 18px;
      height: 18px;
    }
    
    .radio-option label {
      font-size: 0.95rem;
      display: block;
    }
    
    .radio-option small {
      color: #666;
      font-size: 0.85rem;
      display: block;
      margin-top: 4px;
      line-height: 1.4;
    }
    
    .btn-analyze {
      background-color: var(--secondary);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 14px 20px;
      font-size: 1.1rem;
      font-weight: 500;
      width: 100%;
      cursor: pointer;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    
    .btn-analyze:hover:not(:disabled) {
      background-color: #b22217;
    }
    
    .btn-analyze:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 15px;
    }
    
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 4px solid white;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .model-status {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .model-status.loading {
      background-color: #e3f2fd;
      color: var(--primary);
    }
    
    .model-status.success {
      background-color: #e8f5e9;
      color: var(--low);
    }
    
    .model-status.error {
      background-color: #ffebee;
      color: var(--critical);
    }
    
    /* Mapa */
    .map-container {
      flex: 1;
      position: relative;
    }
    
    #map {
      height: 100%;
      width: 100%;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .results-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      width: 300px;
      padding: 20px;
      z-index: 1000;
      transition: all 0.3s;
    }
    
    .results-panel h2 {
      text-align: center;
      margin-bottom: 15px;
      color: var(--primary);
      font-size: 1.4rem;
    }
    
    .risk-level {
      text-align: center;
      font-size: 2.5rem;
      font-weight: bold;
      margin: 15px 0;
      color: var(--critical);
    }
    
    .risk-level.critical { color: var(--critical); }
    .risk-level.high { color: var(--high); }
    .risk-level.moderate { color: var(--moderate); }
    .risk-level.low { color: var(--low); }
    
    .progress-bar {
      height: 20px;
      background-color: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      margin: 15px 0;
    }
    
    .progress-fill {
      height: 100%;
      border-radius: 10px;
      transition: width 0.5s;
    }
    
    .progress-fill.critical { background-color: var(--critical); }
    .progress-fill.high { background-color: var(--high); }
    .progress-fill.moderate { background-color: var(--moderate); }
    .progress-fill.low { background-color: var(--low); }
    
    .result-item {
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #eee;
    }
    
    .result-item:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    
    .result-item .label {
      color: #666;
      font-weight: 500;
      display: block;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }
    
    .result-item .value {
      font-weight: bold;
      font-size: 1.1rem;
    }
    
    .accion {
      color: var(--secondary);
      font-weight: bold;
      font-size: 1.2rem;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px dashed #eee;
    }
    
    .meta-info {
      font-size: 0.85rem;
      color: #666;
      margin-top: 15px;
      text-align: right;
    }
    
    .hidden {
      display: none;
    }
    
    /* Footer */
    footer {
      background-color: var(--primary);
      color: white;
      text-align: center;
      padding: 15px;
      font-size: 0.9rem;
    }
    
    /* Responsive */
    @media (max-width: 992px) {
      .container {
        flex-direction: column;
      }
      
      .sidebar {
        height: 200px;
        overflow: visible;
      }
      
      .map-container {
        height: 400px;
      }
    }
    
    @media (max-width: 768px) {
      .results-panel {
        width: 90%;
        left: 5%;
        right: auto;
      }
      
      .section {
        padding: 12px;
      }
    }
    
    @media (max-width: 576px) {
      .sidebar {
        padding: 15px;
      }
      
      .section h2 {
        font-size: 1.1rem;
      }
      
      .btn-analyze {
        padding: 12px;
        font-size: 1rem;
      }
      
      .risk-level {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar izquierdo -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h1>GeoRiesgo Caracas</h1>
        <p>Sistema de Alerta Temprana - Municipio Libertador</p>
      </div>
      
      <div class="section">
        <h2><i class="fas fa-brain"></i> Estado del Modelo</h2>
        <div id="model-status" class="model-status loading">
          <i class="fas fa-spinner fa-spin"></i>
          <span>Cargando modelo CNN-LSTM...</span>
        </div>
      </div>
      
      <div class="section">
        <h2><i class="fas fa-map-marked-alt"></i> Zona Geogr√°fica</h2>
        <div class="radio-option">
          <input type="radio" id="valle_central" name="zona" value="valle_central" checked>
          <label for="valle_central">Valle Central (Bajo riesgo)</label>
          <small>√Åreas planas urbanizadas del centro de Caracas</small>
        </div>
        
        <div class="radio-option">
          <input type="radio" id="ladera_vulnerable" name="zona" value="ladera_vulnerable">
          <label for="ladera_vulnerable">Laderas Medias (Riesgo moderado)</label>
          <small>Ant√≠mano, Caricuao, zonas de pendiente media</small>
        </div>
        
        <div class="radio-option">
          <input type="radio" id="cerro_pendiente" name="zona" value="cerro_pendiente">
          <label for="cerro_pendiente">Cerros Altos (Alto riesgo)</label>
          <small>El Para√≠so, San Agust√≠n, cerros con alta pendiente</small>
        </div>
        
        <div class="radio-option">
          <input type="radio" id="quebrada" name="zona" value="quebrada">
          <label for="quebrada">Cercan√≠a a Quebradas</label>
          <small>Zonas adyacentes a drenajes naturales (Quebrada Seca, Anauco)</small>
        </div>
        
        <div class="radio-option">
          <input type="radio" id="seguro" name="zona" value="seguro">
          <label for="seguro">Zonas Consolidadas</label>
          <small>Chacao, El Rosal, √°reas con obras de mitigaci√≥n</small>
        </div>
      </div>
      
      <div class="section">
        <h2><i class="fas fa-cloud-rain"></i> Escenario Clim√°tico</h2>
        <div class="radio-option">
          <input type="radio" id="seco" name="clima" value="seco">
          <label for="seco">Seco (< 5 mm)</label>
          <small>Condiciones estables sin precipitaci√≥n significativa</small>
        </div>
        
        <div class="radio-option">
          <input type="radio" id="moderado" name="clima" value="moderado" checked>
          <label for="moderado">Lluvias Moderadas (15-25 mm)</label>
          <small>Lluvias intermitentes sin saturaci√≥n de suelos</small>
        </div>
        
        <div class="radio-option">
          <input type="radio" id="intenso" name="clima" value="intenso">
          <label for="intenso">Lluvias Intensas (35-50 mm)</label>
          <small>Umbral cr√≠tico seg√∫n PCV - Riesgo elevado</small>
        </div>
        
        <div class="radio-option">
          <input type="radio" id="extremo" name="clima" value="extremo">
          <label for="extremo">Evento Extremo (> 80 mm)</label>
          <small>Condiciones de emergencia - Alto peligro</small>
        </div>
        
        <div class="radio-option">
          <input type="radio" id="creciente" name="clima" value="creciente">
          <label for="creciente">Patr√≥n Creciente</label>
          <small>Tendencia ascendente que requiere monitoreo intensivo</small>
        </div>
      </div>
      
      <div class="section">
        <button id="btn-analyze" class="btn-analyze" disabled>
          <i class="fas fa-search"></i> ANALIZAR RIESGO
        </button>
        
        <div id="loading" class="loading">
          <div class="spinner"></div>
          <p>Analizando factores geogr√°ficos y clim√°ticos...</p>
        </div>
      </div>
      
      <div class="section">
        <h2><i class="fas fa-info-circle"></i> Protocolo T√©cnico</h2>
        <p><strong>UMBRALES VENEZOLANOS (PCV 2021):</strong></p>
        <p>‚Ä¢ üü¢ <strong>BAJO:</strong> &lt; 30% probabilidad</p>
        <p>‚Ä¢ üü° <strong>MODERADO:</strong> 30-50% ‚Üí Inspecciones cada 2h</p>
        <p>‚Ä¢ üü† <strong>ALTO:</strong> 50-70% ‚Üí Restricci√≥n de acceso</p>
        <p>‚Ä¢ üî¥ <strong>CR√çTICO:</strong> &gt; 70% ‚Üí Evacuaci√≥n inmediata</p>
        <p><strong>CRITERIOS HIDROMETEOROL√ìGICOS:</strong></p>
        <p>‚Ä¢ Umbral cr√≠tico: 35 mm/24h (IGES 2019)</p>
        <p>‚Ä¢ Alerta temprana: Patr√≥n creciente &gt; 15 mm/6h</p>
      </div>
    </div>
    
    <!-- Contenedor del mapa -->
    <div class="map-container">
      <div id="map"></div>
      
      <div id="results-panel" class="results-panel hidden">
        <h2>Resultados del An√°lisis</h2>
        
        <div class="risk-level" id="risk-level">CR√çTICO</div>
        
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 75%"></div>
        </div>
        
        <div class="result-item">
          <span class="label">Probabilidad estimada:</span>
          <span class="value" id="probabilidad">75.3%</span>
        </div>
        
        <div class="result-item">
          <span class="label">Zona analizada:</span>
          <span class="value" id="zona-analizada">Laderas Medias</span>
        </div>
        
        <div class="result-item">
          <span class="label">Escenario clim√°tico:</span>
          <span class="value" id="escenario-climatico">Lluvias Intensas</span>
        </div>
        
        <div class="accion" id="accion-recomendada">
          RESTRICCI√ìN DE ACCESO - Monitoreo continuo cada hora
        </div>
        
        <div class="meta-info">
          An√°lisis generado: <span id="timestamp">2023-10-25 14:30:22</span>
        </div>
      </div>
    </div>
  </div>
  
  <footer>
    <p>GeoRiesgo Caracas v2.0.0 | ¬© 2026 Universidad Nacional Experimental Sim√≥n Rodr√≠guez (UNES)</p>
    <p>Sistema de Alerta Temprana para Deslizamientos - Tesis Doctoral</p>
  </footer>

  <!-- Librer√≠as -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
          integrity="sha256-p4NxA76iV4Li19fHCp9I8l9Jj3V5k8Xm8cYHm6Q6qQ3j8=" 
          crossorigin=""></script>
  <script src="https://unpkg.com/parse@3.5.0/dist/parse.min.js"></script>
  <!-- TensorFlow.js - Versi√≥n compatible con modelos Keras 3 -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>
  
  <script>
    // Configuraci√≥n de Back4App
    const APP_ID = "YgjmGwaGtyYUZnGloT0syTs7NXHilTDrf0oOH8nz";
    const JS_KEY = "gmc7eoAhx2naPTHnLRwl7CYEGA8Gm2YN1stgOYXe";
    const SERVER_URL = "https://parseapi.back4app.com/";
    
    // Inicializar Parse
    Parse.initialize(APP_ID, JS_KEY);
    Parse.serverURL = SERVER_URL;
    
    // Variables globales
    let zonaActual = "valle_central";
    let climaActual = "moderado";
    let map;
    let marker;
    let polygon;
    let resultsPanel;
    let modelLoaded = false;
    let model;
    
    // Coordenadas de zonas del Libertador
    const zonesGeo = {
      "valle_central": [10.5000, -66.8800],
      "ladera_vulnerable": [10.5150, -66.8950],
      "cerro_pendiente": [10.5300, -66.8650],
      "quebrada": [10.4950, -66.9100],
      "seguro": [10.4850, -66.8550]
    };
    
    // Coordenadas de pol√≠gonos para cada zona
    const zonesPolygons = {
      "valle_central": [
        [10.4850, -66.9000], [10.4850, -66.8600],
        [10.5150, -66.8600], [10.5150, -66.9000]
      ],
      "ladera_vulnerable": [
        [10.5000, -66.9150], [10.5000, -66.8750],
        [10.5300, -66.8750], [10.5300, -66.9150]
      ],
      "cerro_pendiente": [
        [10.5150, -66.8850], [10.5150, -66.8450],
        [10.5450, -66.8450], [10.5450, -66.8850]
      ],
      "quebrada": [
        [10.4800, -66.9300], [10.4800, -66.8900],
        [10.5100, -66.8900], [10.5100, -66.9300]
      ],
      "seguro": [
        [10.4700, -66.8750], [10.4700, -66.8350],
        [10.5000, -66.8350], [10.5000, -66.8750]
      ]
    };
    
    // Colores para cada nivel de riesgo
    const riskColors = {
      "CR√çTICO": "#d62728",
      "ALTO": "#ff7f0e",
      "MODERADO": "#ffcc00",
      "BAJO": "#2ca02c"
    };
    
    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', function() {
      // Inicializar mapa
      initMap();
      
      // Inicializar elementos del DOM
      initElements();
      
      // Configurar eventos
      setupEventListeners();
      
      // Cargar modelo (as√≠ncrono)
      loadModel();
    });
    
    function initMap() {
      // Inicializar mapa de OpenStreetMap
      map = L.map('map').setView([10.5000, -66.8800], 12);
      
      // A√±adir capa de mapa
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      
      // A√±adir marcadores para zonas
      addZoneMarkers();
      
      // A√±adir pol√≠gonos de referencia
      addReferencePolygons();
      
      // Agregar control de escala
      L.control.scale().addTo(map);
    }
    
    function addZoneMarkers() {
      const zones = {
        "valle_central": "Valle Central",
        "ladera_vulnerable": "Laderas Medias",
        "cerro_pendiente": "Cerros Altos",
        "quebrada": "Quebradas",
        "seguro": "Zonas Consolidadas"
      };
      
      const colors = {
        "valle_central": "green",
        "ladera_vulnerable": "orange",
        "cerro_pendiente": "red",
        "quebrada": "darkred",
        "seguro": "blue"
      };
      
      for (const [zoneId, zoneName] of Object.entries(zones)) {
        const [lat, lon] = zonesGeo[zoneId];
        
        L.marker([lat, lon], {
          icon: L.divIcon({
            className: 'custom-marker',
            html: `<div style="background-color: ${colors[zoneId]}; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">${zoneName.charAt(0)}</div>`,
            iconSize: [24, 24],
            iconAnchor: [12, 12]
          })
        }).addTo(map)
        .bindPopup(`<b>${zoneName}</b><br>√Årea de an√°lisis`)
        .on('click', () => {
          document.querySelector(`input[name="zona"][value="${zoneId}"]`).checked = true;
          zonaActual = zoneId;
        });
      }
    }
    
    function addReferencePolygons() {
      // Pol√≠gono para laderas vulnerables
      L.polygon(zonesPolygons.ladera_vulnerable, {
        color: 'orange',
        fillColor: '#fff9e6',
        fillOpacity: 0.4,
        weight: 2
      }).addTo(map)
      .bindPopup('Zonas de laderas vulnerables');
      
      // Pol√≠gono para cerros de alto riesgo
      L.polygon(zonesPolygons.cerro_pendiente, {
        color: 'red',
        fillColor: '#ffe6e6',
        fillOpacity: 0.4,
        weight: 2
      }).addTo(map)
      .bindPopup('Zonas de cerros de alto riesgo');
    }
    
    function initElements() {
      resultsPanel = document.getElementById('results-panel');
      document.getElementById('btn-analyze').addEventListener('click', analyzeRisk);
      document.getElementById('loading').addEventListener('click', analyzeRisk);
    }
    
    function setupEventListeners() {
      // Evento para zona geogr√°fica
      document.querySelectorAll('input[name="zona"]').forEach(radio => {
        radio.addEventListener('change', function() {
          if (this.checked) {
            zonaActual = this.value;
          }
        });
      });
      
      // Evento para escenario clim√°tico
      document.querySelectorAll('input[name="clima"]').forEach(radio => {
        radio.addEventListener('change', function() {
          if (this.checked) {
            climaActual = this.value;
          }
        });
      });
    }
    
    // ==================== CARGA DEL MODELO ====================
    async function loadModel() {
  try {
    console.log("üîÑ Cargando modelo CNN-LSTM...");
    const statusEl = document.getElementById('model-status');
    statusEl.className = "model-status loading";
    statusEl.innerHTML = `<i class="fas fa-spinner fa-spin"></i> <span>Cargando modelo CNN-LSTM...</span>`;
    
    // RUTA CORRECTA para Netlify
    // RUTA CORRECTA: El modelo est√° en /model/ (no en /model/docs/)
    const modelPath = '/model/mejor_modelo_libertador.keras';
    
    // Verificar si el modelo es accesible
    console.log(`üîç Verificando modelo en: ${modelPath}`);
    const response = await fetch(modelPath);
    
    if (!response.ok) {
      console.error(`‚ùå Modelo no encontrado en ${modelPath} (Status: ${response.status})`);
      throw new Error(`El modelo no se encuentra en la ruta: ${modelPath}`);
    }
    
    // Cargar el modelo
    model = await tf.loadLayersModel(modelPath);
    console.log("‚úÖ Modelo CNN-LSTM cargado exitosamente");
    
    // Actualizar estado
    statusEl.className = "model-status success";
    statusEl.innerHTML = `<i class="fas fa-check-circle"></i> <span>Modelo CNN-LSTM listo para an√°lisis</span>`;
    modelLoaded = true;
    
    // Habilitar bot√≥n de an√°lisis
    document.getElementById('btn-analyze').disabled = false;
    
    return true;
  } catch (error) {
    console.error("‚ùå Error al cargar el modelo:", error);
    
    // Mostrar estado de error
    const statusEl = document.getElementById('model-status');
    statusEl.className = "model-status error";
    statusEl.innerHTML = `
      <i class="fas fa-exclamation-triangle"></i> 
      <span>Modelo no disponible. Verifica:</span>
      <div style="font-size: 0.8rem; margin-top: 5px; color: #d32f2f;">
        1. El modelo est√° en <b>/model/mejor_modelo_libertador.keras</b>
        2. El repositorio es P√öBLICO
        3. Visita directamente: <a href="${modelPath}" target="_blank" style="color: #d32f2f;">${modelPath}</a>
        4. El modelo debe estar en formato .keras (Keras 3)
        5. Error detallado: <span style="font-size: 0.7rem; color: #b71c1c;">${error.message}</span>
      </div>
    `;
    
    // Habilitar bot√≥n pero con advertencia
    document.getElementById('btn-analyze').disabled = false;
    modelLoaded = false;
    
    return false;
  }
}
    
    // ==================== AN√ÅLISIS DE RIESGO ====================
    function analyzeRisk() {
      const btn = document.getElementById('btn-analyze');
      const loading = document.getElementById('loading');
      
      // Deshabilitar bot√≥n durante an√°lisis
      btn.disabled = true;
      
      // Mostrar loading
      loading.style.display = 'block';
      
      // Ejecutar an√°lisis (as√≠ncrono)
      setTimeout(() => {
        executeAnalysis();
        
        // Volver a habilitar bot√≥n
        btn.disabled = false;
        
        // Ocultar loading
        loading.style.display = 'none';
      }, 500);
    }
    
    async function executeAnalysis() {
      let prob, nivel, colorClass, accion;
      
      if (modelLoaded && model) {
        // ==================== USAR MODELO REAL ====================
        try {
          console.log("üß† Ejecutando predicci√≥n con modelo CNN-LSTM...");
          
          // Preparar entradas (mismo formato que en Python)
          const parche = crearParcheDummy(zonaActual);
          const secuencia = crearSecuenciaClimatica(climaActual);
          
          // Hacer predicci√≥n
          // El modelo espera dos entradas: [secuencia_temporal, parche_espacial]
          const prediction = model.predict([secuencia, parche]);
          const probArray = await prediction.data();
          prob = probArray[0];
          
          console.log(`‚úÖ Predicci√≥n exitosa: ${prob.toFixed(4)}`);
          
        } catch (error) {
          console.error("‚ùå Error en la predicci√≥n con modelo:", error);
          // Fallback a simulaci√≥n
          prob = simulatePrediction();
        }
      } else {
        // ==================== USAR SIMULACI√ìN ====================
        console.log("üé≤ Usando simulaci√≥n realista (modelo no disponible)");
        prob = simulatePrediction();
      }
      
      // Clasificar riesgo
      if (prob >= 0.7) {
        nivel = "CR√çTICO";
        colorClass = "critical";
        accion = "EVACUACI√ìN INMEDIATA - Activar protocolo rojo PCV";
      } else if (prob >= 0.5) {
        nivel = "ALTO";
        colorClass = "high";
        accion = "RESTRICCI√ìN DE ACCESO - Monitoreo continuo cada hora";
      } else if (prob >= 0.3) {
        nivel = "MODERADO";
        colorClass = "moderate";
        accion = "VIGILANCIA ESPECIAL - Inspecciones t√©cnicas cada 2 horas";
      } else {
        nivel = "BAJO";
        colorClass = "low";
        accion = "VIGILANCIA EST√ÅNDAR - Monitoreo rutinario";
      }
      
      // Actualizar resultados
      updateResults(nivel, prob, accion, colorClass);
      
      // Guardar en Back4App
      saveAnalysisToBack4App(nivel, prob, accion);
      
      // Resaltar zona en el mapa
      highlightRiskZone();
    }
    
    // ==================== FUNCIONES DE SIMULACI√ìN ====================
    function simulatePrediction() {
      // Simular predicci√≥n con l√≥gica realista (mismo que en Python)
      const baseRisk = {
        "valle_central": 0.10,
        "ladera_vulnerable": 0.45,
        "cerro_pendiente": 0.65,
        "quebrada": 0.75,
        "seguro": 0.15
      }[zonaActual] || 0.3;
      
      const rainFactor = {
        "seco": 0.5,
        "moderado": 1.0,
        "intenso": 1.8,
        "extremo": 2.5,
        "creciente": 1.5
      }[climaActual] || 1.0;
      
      let prob = baseRisk * rainFactor * (0.9 + Math.random() * 0.2);
      prob = Math.min(0.95, prob);
      prob = Math.max(0.05, prob);
      
      return prob;
    }
    
    // ==================== FUNCIONES PARA EL MODELO ====================
    function crearParcheDummy(zona) {
      // Crear tensor 4D: [1, 24, 24, 4]
      // Mismo algoritmo que en Python
      const valuesMap = {
        "valle_central": [0.05, 0.15, 0.1, 0.25, 0.3, 0.5, 0.8, 1.0],
        "ladera_vulnerable": [0.2, 0.35, 0.4, 0.7, 0.1, 0.3, 0.6, 0.8],
        "cerro_pendiente": [0.45, 0.55, 0.6, 0.9, 0.2, 0.4, 0.5, 0.7],
        "quebrada": [0.1, 0.25, 0.3, 0.6, 0.0, 0.07, 0.4, 0.6],
        "seguro": [0.05, 0.15, 0.0, 0.1, 0.7, 1.0, 0.8, 1.0]
      };
      
      const values = valuesMap[zona] || valuesMap["valle_central"];
      const data = new Float32Array(24 * 24 * 4);
      
      for (let i = 0; i < data.length; i++) {
        const channel = Math.floor(i / (24 * 24));
        const rand = Math.random();
        
        if (channel === 0) data[i] = values[0] + rand * (values[1] - values[0]);
        else if (channel === 1) data[i] = values[2] + rand * (values[3] - values[2]);
        else if (channel === 2) data[i] = values[4] + rand * (values[5] - values[4]);
        else data[i] = values[6] + rand * (values[7] - values[6]);
      }
      
      return tf.tensor4d(data, [1, 24, 24, 4]);
    }
    
    function crearSecuenciaClimatica(clima) {
      // Crear tensor 3D: [1, 24, 5]
      // Mismo algoritmo que en Python
      const baseValues = {
        "seco": [0, 0.5, 24, 28, 60, 75],
        "moderado": [1.5, 1.2, 25, 1, 75, 5],
        "intenso": [2.5, 2.0, 24, 0.2, 80, 4],
        "extremo": [4, 3, 23, 0.3, 85, 3],
        "creciente": [0.2, 3.0, 25, 0.15, 70, 6]
      };
      
      const values = baseValues[clima] || baseValues["moderado"];
      const data = new Float32Array(24 * 5);
      
      for (let i = 0; i < 24; i++) {
        const basePrecip = values[0] + Math.random() * values[1];
        const precip = i < 16 ? basePrecip : basePrecip + Math.random() * 2;
        
        const temp = values[2] - values[3] * precip + Math.random();
        const humedad = values[4] + values[5] * precip + Math.random();
        
        // Acumulados (simplificado para frontend)
        const acum24h = precip * 3;
        const acum72h = precip * 3;
        
        data[i * 5 + 0] = precip;
        data[i * 5 + 1] = temp;
        data[i * 5 + 2] = humedad;
        data[i * 5 + 3] = acum24h;
        data[i * 5 + 4] = acum72h;
      }
      
      return tf.tensor3d(data, [1, 24, 5]);
    }
    
    // ==================== ACTUALIZACI√ìN DE RESULTADOS ====================
    function updateResults(nivel, prob, accion, colorClass) {
      // Actualizar UI
      document.getElementById('risk-level').textContent = nivel;
      document.getElementById('risk-level').className = 'risk-level ' + colorClass;
      
      document.getElementById('probabilidad').textContent = (prob * 100).toFixed(1) + '%';
      document.getElementById('progress-fill').style.width = (prob * 100) + '%';
      document.getElementById('progress-fill').className = 'progress-fill ' + colorClass;
      
      document.getElementById('zona-analizada').textContent = 
        zonaActual.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());
      
      document.getElementById('escenario-climatico').textContent = 
        climaActual.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());
      
      document.getElementById('accion-recomendada').textContent = accion;
      
      document.getElementById('timestamp').textContent = new Date().toISOString().replace('T', ' ').substring(0, 19);
      
      // Mostrar panel de resultados
      resultsPanel.classList.remove('hidden');
      
      // Centrar mapa en la zona analizada
      const [lat, lon] = zonesGeo[zonaActual];
      map.setView([lat, lon], 13);
    }
    
    function highlightRiskZone() {
      // Eliminar overlay anterior si existe
      if (polygon) {
        map.removeLayer(polygon);
      }
      
      // Crear nuevo pol√≠gono
      const color = riskColors[document.getElementById('risk-level').textContent];
      const zonePolygon = zonesPolygons[zonaActual];
      
      polygon = L.polygon(zonePolygon, {
        color: 'black',
        fillColor: color,
        fillOpacity: 0.4,
        weight: 3
      }).addTo(map)
      .bindPopup(`
        <b>Zona en Riesgo</b><br>
        Nivel: ${document.getElementById('risk-level').textContent}<br>
        Probabilidad: ${document.getElementById('probabilidad').textContent}
      `);
      
      // A√±adir marcador
      if (marker) {
        map.removeLayer(marker);
      }
      
      const [lat, lon] = zonesGeo[zonaActual];
      marker = L.marker([lat, lon], {
        icon: L.divIcon({
          className: 'custom-marker',
          html: `<div style="background-color: ${color}; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px;">${document.getElementById('risk-level').textContent.charAt(0)}</div>`,
          iconSize: [32, 32],
          iconAnchor: [16, 16]
        })
      }).addTo(map)
      .bindPopup(`
        <b>Zona Analizada</b><br>
        Nivel: ${document.getElementById('risk-level').textContent}
      `);
    }
    
    function saveAnalysisToBack4App(nivel, prob, accion) {
      try {
        // Crear objeto de an√°lisis
        const Analysis = Parse.Object.extend("AnalysisHistory");
        const analysis = new Analysis();
        
        // Establecer propiedades
        analysis.set("zona", zonaActual);
        analysis.set("clima", climaActual);
        analysis.set("probabilidad", prob);
        analysis.set("nivelRiesgo", nivel);
        analysis.set("accionRecomendada", accion);
        analysis.set("timestamp", new Date());
        analysis.set("coordenadas", zonesGeo[zonaActual]);
        
        // Guardar en Back4App
        analysis.save()
          .then(() => console.log("‚úÖ An√°lisis guardado en Back4App"))
          .catch(error => console.error("‚ùå Error al guardar en Back4App:", error));
      } catch (error) {
        console.error("‚ùå Error al guardar en Back4App:", error);
      }
    }
  </script>
</body>
</html>
